@IsTest
private class WeatherBatchJobTest {

    // Simple success mock reused for the batch test
    private class WeatherSuccessMock implements HttpCalloutMock {
        public HTTPResponse respond(HTTPRequest req) {
            HttpResponse res = new HttpResponse();
            res.setStatusCode(200);
            res.setStatus('OK');

            // Same kind of JSON as in the other tests
            res.setBody('{' +
                '"main":{"temp":18,"humidity":55,"pressure":1012},' +
                '"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],' +
                '"wind":{"speed":4,"deg":200},' +
                '"name":"Batch Test City",' +
                '"sys":{"country":"GB"},' +
                '"dt":1726660758' +
            '}');

            return res;
        }
    }

    // Note: We assume Weather_Config__mdt Default record already exists in the org.

    @IsTest
    static void testBatchCreatesWeatherForLocationsWithCoords() {
        // Prepare test data
        Location__c withCoords = new Location__c(
            Name         = 'Batch Location With Coords',
            Latitude__c  = 51.5074,
            Longitude__c = -0.1278
        );
        Location__c withoutCoords = new Location__c(
            Name = 'Batch Location Without Coords'
            // No latitude or longitude
        );
        insert new List<Location__c>{ withCoords, withoutCoords };

        // Set callout mock so the batch can call the API client
        Test.setMock(HttpCalloutMock.class, new WeatherSuccessMock());

        Test.startTest();
        // Execute batch with small scope size to force execute call
        Id jobId = Database.executeBatch(new WeatherBatchJob(), 1);
        Test.stopTest();

        // Assert: WeatherInfo__c created for the location that has coordinates
        List<WeatherInfo__c> infos = [
            SELECT Location__c, Temperature__c, Description__c, IsLatest__c
            FROM WeatherInfo__c
            WHERE Location__c IN :new Id[]{ withCoords.Id, withoutCoords.Id }
        ];

        // There should be at least one record, and none for the no-coords location
        Boolean hasWithCoords = false;
        Boolean hasWithoutCoords = false;
        for (WeatherInfo__c wi : infos) {
            if (wi.Location__c == withCoords.Id) {
                hasWithCoords = true;
            }
            if (wi.Location__c == withoutCoords.Id) {
                hasWithoutCoords = true;
            }
        }

        System.assertEquals(true, hasWithCoords,
            'Batch should create WeatherInfo__c for locations that have coordinates');
        System.assertEquals(false, hasWithoutCoords,
            'Batch should not create WeatherInfo__c for locations without coordinates');

        // Optional: also check that Last_Weather_Updated__c and status were set
        Location__c updatedWithCoords = [
            SELECT Last_Weather_Updated__c, Last_Weather_Status__c
            FROM Location__c
            WHERE Id = :withCoords.Id
        ];
        System.assertNotEquals(null, updatedWithCoords.Last_Weather_Updated__c,
            'Batch should update Last_Weather_Updated__c');
        System.assertEquals('Success', updatedWithCoords.Last_Weather_Status__c,
            'Batch should set status to Success or similar');
    }
}
