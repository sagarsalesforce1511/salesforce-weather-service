@IsTest
private class WeatherApiClientTest {

    // Mock for a successful response from OpenWeather
    private class WeatherSuccessMock implements HttpCalloutMock {
        public HTTPResponse respond(HTTPRequest req) {
            HttpResponse res = new HttpResponse();
            res.setStatusCode(200);
            res.setStatus('OK');

            // Minimal valid JSON similar to real OpenWeather response
            res.setBody('{' +
                '"main":{"temp":20,"humidity":60,"pressure":1015},' +
                '"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],' +
                '"wind":{"speed":3.5,"deg":120},' +
                '"name":"Test City",' +
                '"sys":{"country":"GB"},' +
                '"dt":1726660758' +
            '}');

            return res;
        }
    }

    // Mock for an error (non-200) response
    private class WeatherErrorMock implements HttpCalloutMock {
        public HTTPResponse respond(HTTPRequest req) {
            HttpResponse res = new HttpResponse();
            res.setStatusCode(401);
            res.setStatus('Unauthorized');
            res.setBody('{"message":"Invalid API key"}');
            return res;
        }
    }

    // Note: We assume Weather_Config__mdt Default record already exists
    // in the org with a valid (or dummy) API key.

    @IsTest
    static void testGetCurrentWeather_Success() {
        Test.setMock(HttpCalloutMock.class, new WeatherSuccessMock());

        Test.startTest();
        WeatherApiClient.CurrentWeatherResponse res =
            WeatherApiClient.getCurrentWeather(51.5074, -0.1278);
        Test.stopTest();

        System.assertNotEquals(null, res, 'Response should not be null');
        System.assertNotEquals(null, res.main, 'Main block should not be null');
        System.assertEquals(20, res.main.temp, 'Temperature should match mock value');
        System.assertEquals(60, res.main.humidity, 'Humidity should match mock value');
        System.assertEquals('clear sky', res.weather[0].description, 'Description should match mock');
    }

    @IsTest
    static void testGetCurrentWeather_ErrorStatus() {
        Test.setMock(HttpCalloutMock.class, new WeatherErrorMock());

        Test.startTest();
        Boolean thrown = false;
        try {
            WeatherApiClient.getCurrentWeather(51.5074, -0.1278);
        } catch (WeatherApiClient.WeatherException e) {
            thrown = true;
        }
        Test.stopTest();

        System.assertEquals(true, thrown,
            'WeatherException should be thrown when API returns non-200 status');
    }

    @IsTest
    static void testGetCurrentWeather_NullLatLon() {
        Test.startTest();
        Boolean thrown = false;
        try {
            WeatherApiClient.getCurrentWeather(null, null);
        } catch (WeatherApiClient.WeatherException e) {
            thrown = true;
        }
        Test.stopTest();

        System.assertEquals(true, thrown,
            'WeatherException should be thrown when lat and lon are null');
    }
}
